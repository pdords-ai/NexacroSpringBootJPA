<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nexacro 고급 기능 - 고급 그리드 기능</title>
    <script type="text/javascript" src="http://localhost:8080/nexacro/nexacro.js"></script>
</head>
<body>
    <script type="text/javascript">
        /*
            ===== 고급 그리드 기능 예제 =====
            
            이 예제에서는 DHTMLX 그리드와 유사한 고급 기능들을 배웁니다:
            1. 그리드 정렬 (단일/다중 컬럼)
            2. 데이터 필터링 (텍스트, 숫자, 날짜)
            3. 그룹핑과 집계
            4. 인라인 편집
            5. 행 선택과 다중 선택
            6. 컬럼 숨기기/보이기
            7. 데이터 내보내기
            8. 가상 스크롤링
        */
        function on_application_ready() {
            
            /*
                ===== 1단계: 데이터셋 설정 =====
                더 복잡한 데이터 구조를 만들어보겠습니다
            */
            var salesDataset = new nexacro.Dataset("salesDataset");
            
            // 컬럼 정의
            salesDataset.addColumn("id", "number");           // ID
            salesDataset.addColumn("productName", "string");   // 제품명
            salesDataset.addColumn("category", "string");      // 카테고리
            salesDataset.addColumn("price", "number");         // 가격
            salesDataset.addColumn("quantity", "number");      // 수량
            salesDataset.addColumn("total", "number");         // 총액
            salesDataset.addColumn("salesDate", "string");     // 판매일
            salesDataset.addColumn("salesperson", "string");   // 판매원
            salesDataset.addColumn("region", "string");        // 지역
            salesDataset.addColumn("status", "string");        // 상태
            
            // Spring Backend API에서 데이터 로드
            loadSalesDataFromAPI();
            
            /*
                ===== 2단계: UI 컴포넌트들 만들기 =====
            */
            
            // 제목
            var titleLabel = new nexacro.Label("titleLabel");
            titleLabel.set_text("고급 그리드 기능 - Spring Backend API 연동 판매 데이터 관리");
            titleLabel.set_left(50);
            titleLabel.set_top(20);
            titleLabel.set_width(800);
            titleLabel.set_height(40);
            titleLabel.set_font("bold 18px Arial");
            titleLabel.set_color("darkblue");
            titleLabel.set_background("lightblue");
            
            // 툴바 컨테이너
            var toolbarContainer = new nexacro.Container("toolbarContainer");
            toolbarContainer.set_left(50);
            toolbarContainer.set_top(70);
            toolbarContainer.set_width(1000);
            toolbarContainer.set_height(50);
            toolbarContainer.set_background("lightgray");
            toolbarContainer.set_border("1px solid #ccc");
            
            // 툴바 버튼들
            var sortButton = new nexacro.Button("sortButton");
            sortButton.set_text("정렬");
            sortButton.set_left(10);
            sortButton.set_top(10);
            sortButton.set_width(80);
            sortButton.set_height(30);
            sortButton.set_background("lightblue");
            
            var filterButton = new nexacro.Button("filterButton");
            filterButton.set_text("필터");
            filterButton.set_left(100);
            filterButton.set_top(10);
            filterButton.set_width(80);
            filterButton.set_height(30);
            filterButton.set_background("lightgreen");
            
            var groupButton = new nexacro.Button("groupButton");
            groupButton.set_text("그룹핑");
            groupButton.set_left(190);
            groupButton.set_top(10);
            groupButton.set_width(80);
            groupButton.set_height(30);
            groupButton.set_background("lightyellow");
            
            var editButton = new nexacro.Button("editButton");
            editButton.set_text("편집모드");
            editButton.set_left(280);
            editButton.set_top(10);
            editButton.set_width(80);
            editButton.set_height(30);
            editButton.set_background("lightcoral");
            
            var exportButton = new nexacro.Button("exportButton");
            exportButton.set_text("내보내기");
            exportButton.set_left(370);
            exportButton.set_top(10);
            exportButton.set_width(80);
            exportButton.set_height(30);
            exportButton.set_background("lightpurple");
            
            var refreshButton = new nexacro.Button("refreshButton");
            refreshButton.set_text("새로고침");
            refreshButton.set_left(460);
            refreshButton.set_top(10);
            refreshButton.set_width(80);
            refreshButton.set_height(30);
            refreshButton.set_background("lightgray");
            
            var addButton = new nexacro.Button("addButton");
            addButton.set_text("데이터 추가");
            addButton.set_left(550);
            addButton.set_top(10);
            addButton.set_width(80);
            addButton.set_height(30);
            addButton.set_background("lightgreen");
            
            var deleteButton = new nexacro.Button("deleteButton");
            deleteButton.set_text("선택 삭제");
            deleteButton.set_left(640);
            deleteButton.set_top(10);
            deleteButton.set_width(80);
            deleteButton.set_height(30);
            deleteButton.set_background("lightcoral");
            
            var statsButton = new nexacro.Button("statsButton");
            statsButton.set_text("통계 새로고침");
            statsButton.set_left(730);
            statsButton.set_top(10);
            statsButton.set_width(100);
            statsButton.set_height(30);
            statsButton.set_background("lightblue");
            
            // 필터 컨테이너
            var filterContainer = new nexacro.Container("filterContainer");
            filterContainer.set_left(50);
            filterContainer.set_top(130);
            filterContainer.set_width(1000);
            filterContainer.set_height(60);
            filterContainer.set_background("lightyellow");
            filterContainer.set_border("1px solid #ccc");
            filterContainer.set_visible(false); // 처음에는 숨김
            
            // 필터 입력 필드들
            var productFilterLabel = new nexacro.Label("productFilterLabel");
            productFilterLabel.set_text("제품명:");
            productFilterLabel.set_left(10);
            productFilterLabel.set_top(20);
            productFilterLabel.set_width(60);
            productFilterLabel.set_height(20);
            
            var productFilterText = new nexacro.TextBox("productFilterText");
            productFilterText.set_left(80);
            productFilterText.set_top(20);
            productFilterText.set_width(120);
            productFilterText.set_height(20);
            productFilterText.set_placeholder("제품명 검색");
            
            var categoryFilterLabel = new nexacro.Label("categoryFilterLabel");
            categoryFilterLabel.set_text("카테고리:");
            categoryFilterLabel.set_left(220);
            categoryFilterLabel.set_top(20);
            categoryFilterLabel.set_width(60);
            categoryFilterLabel.set_height(20);
            
            var categoryFilterCombo = new nexacro.ComboBox("categoryFilterCombo");
            categoryFilterCombo.set_left(290);
            categoryFilterCombo.set_top(20);
            categoryFilterCombo.set_width(100);
            categoryFilterCombo.set_height(20);
            categoryFilterCombo.addItem("전체", "all");
            categoryFilterCombo.addItem("전자제품", "전자제품");
            categoryFilterCombo.addItem("가구", "가구");
            categoryFilterCombo.addItem("가전제품", "가전제품");
            
            var regionFilterLabel = new nexacro.Label("regionFilterLabel");
            regionFilterLabel.set_text("지역:");
            regionFilterLabel.set_left(410);
            regionFilterLabel.set_top(20);
            regionFilterLabel.set_width(40);
            regionFilterLabel.set_height(20);
            
            var regionFilterCombo = new nexacro.ComboBox("regionFilterCombo");
            regionFilterCombo.set_left(460);
            regionFilterCombo.set_top(20);
            regionFilterCombo.set_width(80);
            regionFilterCombo.set_height(20);
            regionFilterCombo.addItem("전체", "all");
            regionFilterCombo.addItem("서울", "서울");
            regionFilterCombo.addItem("부산", "부산");
            regionFilterCombo.addItem("대구", "대구");
            regionFilterCombo.addItem("인천", "인천");
            
            var applyFilterButton = new nexacro.Button("applyFilterButton");
            applyFilterButton.set_text("적용");
            applyFilterButton.set_left(560);
            applyFilterButton.set_top(20);
            applyFilterButton.set_width(60);
            applyFilterButton.set_height(20);
            applyFilterButton.set_background("lightgreen");
            
            var clearFilterButton = new nexacro.Button("clearFilterButton");
            clearFilterButton.set_text("초기화");
            clearFilterButton.set_left(630);
            clearFilterButton.set_top(20);
            clearFilterButton.set_width(60);
            clearFilterButton.set_height(20);
            clearFilterButton.set_background("lightcoral");
            
            // 메인 그리드
            var mainGrid = new nexacro.Grid("mainGrid");
            mainGrid.set_left(50);
            mainGrid.set_top(200);
            mainGrid.set_width(1000);
            mainGrid.set_height(400);
            mainGrid.set_border("2px solid #ccc");
            mainGrid.set_dataset(salesDataset);
            mainGrid.set_multiselect(true); // 다중 선택 가능
            
            // 그리드 컬럼 설정
            mainGrid.addColumn("id", "ID", 60);
            mainGrid.addColumn("productName", "제품명", 120);
            mainGrid.addColumn("category", "카테고리", 100);
            mainGrid.addColumn("price", "가격", 100);
            mainGrid.addColumn("quantity", "수량", 80);
            mainGrid.addColumn("total", "총액", 120);
            mainGrid.addColumn("salesDate", "판매일", 100);
            mainGrid.addColumn("salesperson", "판매원", 100);
            mainGrid.addColumn("region", "지역", 80);
            mainGrid.addColumn("status", "상태", 80);
            
            // 상태바
            var statusBar = new nexacro.Label("statusBar");
            statusBar.set_text("준비됨 - 총 " + salesDataset.getRowCount() + "개 레코드");
            statusBar.set_left(50);
            statusBar.set_top(610);
            statusBar.set_width(1000);
            statusBar.set_height(25);
            statusBar.set_background("lightgray");
            statusBar.set_border("1px solid #ccc");
            
            // 통계 정보
            var statsLabel = new nexacro.Label("statsLabel");
            statsLabel.set_text("통계 정보가 여기에 표시됩니다");
            statsLabel.set_left(50);
            statsLabel.set_top(645);
            statsLabel.set_width(1000);
            statsLabel.set_height(40);
            statsLabel.set_background("lightcyan");
            statsLabel.set_border("1px solid #ccc");
            
            /*
                ===== 3단계: API 연동 함수들 =====
            */
            
            // Spring Backend API 기본 URL
            var API_BASE_URL = "http://localhost:8080/api";
            
            /*
                API에서 판매 데이터 로드
            */
            function loadSalesDataFromAPI() {
                statusBar.set_text("데이터를 로드하는 중...");
                
                // XMLHttpRequest를 사용하여 API 호출
                var xhr = new XMLHttpRequest();
                xhr.open("GET", API_BASE_URL + "/sales", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var salesData = JSON.parse(xhr.responseText);
                                populateDatasetFromAPI(salesData);
                                statusBar.set_text("데이터 로드 완료 - 총 " + salesData.length + "개 레코드");
                            } catch (e) {
                                statusBar.set_text("데이터 파싱 오류: " + e.message);
                                loadFallbackData();
                            }
                        } else {
                            statusBar.set_text("API 호출 실패 (상태: " + xhr.status + ") - 샘플 데이터를 사용합니다");
                            loadFallbackData();
                        }
                    }
                };
                
                xhr.send();
            }
            
            /*
                API 데이터로 데이터셋 채우기
            */
            function populateDatasetFromAPI(apiData) {
                salesDataset.clear();
                
                for (var i = 0; i < apiData.length; i++) {
                    var data = apiData[i];
                    var newRow = salesDataset.addRow();
                    salesDataset.setCellData(newRow, "id", data.id);
                    salesDataset.setCellData(newRow, "productName", data.productName);
                    salesDataset.setCellData(newRow, "category", data.category);
                    salesDataset.setCellData(newRow, "price", data.price);
                    salesDataset.setCellData(newRow, "quantity", data.quantity);
                    salesDataset.setCellData(newRow, "total", data.price * data.quantity); // 총액 계산
                    salesDataset.setCellData(newRow, "salesDate", data.salesDate);
                    salesDataset.setCellData(newRow, "salesperson", data.salesperson);
                    salesDataset.setCellData(newRow, "region", data.region);
                    salesDataset.setCellData(newRow, "status", data.status);
                }
                
                // 원본 데이터 백업 업데이트
                originalDataset.clear();
                originalDataset.copyFrom(salesDataset);
                
                updateStatusBar();
            }
            
            /*
                API 호출 실패 시 사용할 샘플 데이터
            */
            function loadFallbackData() {
                var sampleData = [
                    {id: 1, productName: "노트북", category: "전자제품", price: 1200000, quantity: 2, total: 2400000, salesDate: "2024-01-15", salesperson: "김철수", region: "서울", status: "완료"},
                    {id: 2, productName: "마우스", category: "전자제품", price: 25000, quantity: 5, total: 125000, salesDate: "2024-01-16", salesperson: "이영희", region: "부산", status: "완료"},
                    {id: 3, productName: "키보드", category: "전자제품", price: 80000, quantity: 3, total: 240000, salesDate: "2024-01-17", salesperson: "박민수", region: "대구", status: "진행중"},
                    {id: 4, productName: "모니터", category: "전자제품", price: 300000, quantity: 1, total: 300000, salesDate: "2024-01-18", salesperson: "정수진", region: "서울", status: "완료"},
                    {id: 5, productName: "책상", category: "가구", price: 150000, quantity: 2, total: 300000, salesDate: "2024-01-19", salesperson: "최영호", region: "인천", status: "완료"}
                ];
                
                populateDatasetFromAPI(sampleData);
            }
            
            /*
                API로 새 데이터 추가
            */
            function addSalesDataToAPI(salesData) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", API_BASE_URL + "/sales", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 201) {
                            statusBar.set_text("새 데이터가 성공적으로 추가되었습니다");
                            loadSalesDataFromAPI(); // 데이터 새로고침
                        } else {
                            statusBar.set_text("데이터 추가 실패 (상태: " + xhr.status + ")");
                        }
                    }
                };
                
                xhr.send(JSON.stringify(salesData));
            }
            
            /*
                API로 데이터 업데이트
            */
            function updateSalesDataInAPI(id, salesData) {
                var xhr = new XMLHttpRequest();
                xhr.open("PUT", API_BASE_URL + "/sales/" + id, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            statusBar.set_text("데이터가 성공적으로 업데이트되었습니다");
                            loadSalesDataFromAPI(); // 데이터 새로고침
                        } else {
                            statusBar.set_text("데이터 업데이트 실패 (상태: " + xhr.status + ")");
                        }
                    }
                };
                
                xhr.send(JSON.stringify(salesData));
            }
            
            /*
                API로 데이터 삭제
            */
            function deleteSalesDataFromAPI(id) {
                var xhr = new XMLHttpRequest();
                xhr.open("DELETE", API_BASE_URL + "/sales/" + id, true);
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            statusBar.set_text("데이터가 성공적으로 삭제되었습니다");
                            loadSalesDataFromAPI(); // 데이터 새로고침
                        } else {
                            statusBar.set_text("데이터 삭제 실패 (상태: " + xhr.status + ")");
                        }
                    }
                };
                
                xhr.send();
            }
            
            /*
                API로 필터링된 데이터 조회
            */
            function loadFilteredDataFromAPI(category, region, status) {
                var url = API_BASE_URL + "/sales/filter?";
                var params = [];
                
                if (category && category !== "전체") params.push("category=" + encodeURIComponent(category));
                if (region && region !== "전체") params.push("region=" + encodeURIComponent(region));
                if (status && status !== "전체") params.push("status=" + encodeURIComponent(status));
                
                url += params.join("&");
                
                var xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var salesData = JSON.parse(xhr.responseText);
                                populateDatasetFromAPI(salesData);
                                statusBar.set_text("필터링된 데이터 로드 완료 - 총 " + salesData.length + "개 레코드");
                            } catch (e) {
                                statusBar.set_text("필터링 데이터 파싱 오류: " + e.message);
                            }
                        } else {
                            statusBar.set_text("필터링 API 호출 실패 (상태: " + xhr.status + ")");
                        }
                    }
                };
                
                xhr.send();
            }
            
            /*
                API로 통계 데이터 조회
            */
            function loadStatisticsFromAPI() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", API_BASE_URL + "/sales/statistics/overall", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var stats = JSON.parse(xhr.responseText);
                                var statsText = "API 통계 - 총 건수: " + stats.totalCount + "건 | ";
                                statsText += "총 매출: " + stats.totalSales.toLocaleString() + "원 | ";
                                statsText += "평균 매출: " + stats.averageSales.toFixed(0).toLocaleString() + "원 | ";
                                statsText += "최대 매출: " + stats.maxSales.toLocaleString() + "원 | ";
                                statsText += "최소 매출: " + stats.minSales.toLocaleString() + "원";
                                
                                statsLabel.set_text(statsText);
                            } catch (e) {
                                statsLabel.set_text("통계 데이터 파싱 오류: " + e.message);
                            }
                        } else {
                            statsLabel.set_text("통계 API 호출 실패 (상태: " + xhr.status + ")");
                        }
                    }
                };
                
                xhr.send();
            }

            /*
                ===== 4단계: 고급 기능 함수들 =====
            */
            
            // 원본 데이터 백업 (필터링을 위해)
            var originalDataset = new nexacro.Dataset("originalDataset");
            originalDataset.copyFrom(salesDataset);
            
            /*
                정렬 기능
            */
            function sortGrid(columnName, ascending) {
                var rowCount = salesDataset.getRowCount();
                var data = [];
                
                // 데이터를 배열로 복사
                for (var i = 0; i < rowCount; i++) {
                    var row = {};
                    row.id = salesDataset.getCellData(i, "id");
                    row.productName = salesDataset.getCellData(i, "productName");
                    row.category = salesDataset.getCellData(i, "category");
                    row.price = salesDataset.getCellData(i, "price");
                    row.quantity = salesDataset.getCellData(i, "quantity");
                    row.total = salesDataset.getCellData(i, "total");
                    row.salesDate = salesDataset.getCellData(i, "salesDate");
                    row.salesperson = salesDataset.getCellData(i, "salesperson");
                    row.region = salesDataset.getCellData(i, "region");
                    row.status = salesDataset.getCellData(i, "status");
                    row.originalIndex = i;
                    data.push(row);
                }
                
                // 정렬
                data.sort(function(a, b) {
                    var aVal = a[columnName];
                    var bVal = b[columnName];
                    
                    if (typeof aVal === 'string') {
                        return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else {
                        return ascending ? aVal - bVal : bVal - aVal;
                    }
                });
                
                // 정렬된 데이터로 그리드 업데이트
                salesDataset.clear();
                for (var i = 0; i < data.length; i++) {
                    var newRow = salesDataset.addRow();
                    salesDataset.setCellData(newRow, "id", data[i].id);
                    salesDataset.setCellData(newRow, "productName", data[i].productName);
                    salesDataset.setCellData(newRow, "category", data[i].category);
                    salesDataset.setCellData(newRow, "price", data[i].price);
                    salesDataset.setCellData(newRow, "quantity", data[i].quantity);
                    salesDataset.setCellData(newRow, "total", data[i].total);
                    salesDataset.setCellData(newRow, "salesDate", data[i].salesDate);
                    salesDataset.setCellData(newRow, "salesperson", data[i].salesperson);
                    salesDataset.setCellData(newRow, "region", data[i].region);
                    salesDataset.setCellData(newRow, "status", data[i].status);
                }
                
                updateStatusBar();
            }
            
            /*
                필터링 기능 (API 연동)
            */
            function applyFilters() {
                var productFilter = productFilterText.get_text();
                var categoryFilter = categoryFilterCombo.get_text();
                var regionFilter = regionFilterCombo.get_text();
                
                // 제품명 필터가 있는 경우 검색 API 사용
                if (productFilter && productFilter.trim() !== "") {
                    loadSearchDataFromAPI(productFilter);
                } else {
                    // 카테고리, 지역 필터만 있는 경우 필터 API 사용
                    loadFilteredDataFromAPI(categoryFilter, regionFilter, null);
                }
            }
            
            /*
                API로 제품명 검색
            */
            function loadSearchDataFromAPI(productName) {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", API_BASE_URL + "/sales/search?productName=" + encodeURIComponent(productName), true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var salesData = JSON.parse(xhr.responseText);
                                populateDatasetFromAPI(salesData);
                                statusBar.set_text("검색 결과: '" + productName + "' - 총 " + salesData.length + "개 레코드");
                            } catch (e) {
                                statusBar.set_text("검색 데이터 파싱 오류: " + e.message);
                            }
                        } else {
                            statusBar.set_text("검색 API 호출 실패 (상태: " + xhr.status + ")");
                        }
                    }
                };
                
                xhr.send();
            }
            
            /*
                필터 초기화 (API 연동)
            */
            function clearFilters() {
                productFilterText.set_text("");
                categoryFilterCombo.set_text("전체");
                regionFilterCombo.set_text("전체");
                
                // API에서 전체 데이터 다시 로드
                loadSalesDataFromAPI();
            }
            
            /*
                그룹핑 기능
            */
            function groupByCategory() {
                var rowCount = salesDataset.getRowCount();
                var groupedData = {};
                var totals = {};
                
                // 데이터 그룹핑
                for (var i = 0; i < rowCount; i++) {
                    var category = salesDataset.getCellData(i, "category");
                    var total = salesDataset.getCellData(i, "total");
                    
                    if (!groupedData[category]) {
                        groupedData[category] = [];
                        totals[category] = 0;
                    }
                    
                    groupedData[category].push({
                        id: salesDataset.getCellData(i, "id"),
                        productName: salesDataset.getCellData(i, "productName"),
                        category: category,
                        price: salesDataset.getCellData(i, "price"),
                        quantity: salesDataset.getCellData(i, "quantity"),
                        total: total,
                        salesDate: salesDataset.getCellData(i, "salesDate"),
                        salesperson: salesDataset.getCellData(i, "salesperson"),
                        region: salesDataset.getCellData(i, "region"),
                        status: salesDataset.getCellData(i, "status")
                    });
                    
                    totals[category] += total;
                }
                
                // 그룹핑된 데이터로 그리드 업데이트
                salesDataset.clear();
                var newId = 1;
                
                for (var category in groupedData) {
                    // 그룹 헤더 추가
                    var headerRow = salesDataset.addRow();
                    salesDataset.setCellData(headerRow, "id", "");
                    salesDataset.setCellData(headerRow, "productName", "=== " + category + " (총 " + totals[category].toLocaleString() + "원) ===");
                    salesDataset.setCellData(headerRow, "category", "");
                    salesDataset.setCellData(headerRow, "price", "");
                    salesDataset.setCellData(headerRow, "quantity", "");
                    salesDataset.setCellData(headerRow, "total", "");
                    salesDataset.setCellData(headerRow, "salesDate", "");
                    salesDataset.setCellData(headerRow, "salesperson", "");
                    salesDataset.setCellData(headerRow, "region", "");
                    salesDataset.setCellData(headerRow, "status", "");
                    
                    // 그룹 내 데이터 추가
                    for (var j = 0; j < groupedData[category].length; j++) {
                        var data = groupedData[category][j];
                        var newRow = salesDataset.addRow();
                        salesDataset.setCellData(newRow, "id", newId++);
                        salesDataset.setCellData(newRow, "productName", data.productName);
                        salesDataset.setCellData(newRow, "category", data.category);
                        salesDataset.setCellData(newRow, "price", data.price);
                        salesDataset.setCellData(newRow, "quantity", data.quantity);
                        salesDataset.setCellData(newRow, "total", data.total);
                        salesDataset.setCellData(newRow, "salesDate", data.salesDate);
                        salesDataset.setCellData(newRow, "salesperson", data.salesperson);
                        salesDataset.setCellData(newRow, "region", data.region);
                        salesDataset.setCellData(newRow, "status", data.status);
                    }
                }
                
                updateStatusBar();
            }
            
            /*
                편집 모드 토글
            */
            var isEditMode = false;
            function toggleEditMode() {
                isEditMode = !isEditMode;
                if (isEditMode) {
                    editButton.set_text("편집완료");
                    editButton.set_background("lightgreen");
                    mainGrid.set_editable(true);
                    statusBar.set_text("편집 모드 활성화 - 셀을 더블클릭하여 편집하세요");
                } else {
                    editButton.set_text("편집모드");
                    editButton.set_background("lightcoral");
                    mainGrid.set_editable(false);
                    statusBar.set_text("편집 모드 비활성화");
                }
            }
            
            /*
                데이터 내보내기
            */
            function exportData() {
                var rowCount = salesDataset.getRowCount();
                var csvData = "ID,제품명,카테고리,가격,수량,총액,판매일,판매원,지역,상태\n";
                
                for (var i = 0; i < rowCount; i++) {
                    csvData += salesDataset.getCellData(i, "id") + ",";
                    csvData += salesDataset.getCellData(i, "productName") + ",";
                    csvData += salesDataset.getCellData(i, "category") + ",";
                    csvData += salesDataset.getCellData(i, "price") + ",";
                    csvData += salesDataset.getCellData(i, "quantity") + ",";
                    csvData += salesDataset.getCellData(i, "total") + ",";
                    csvData += salesDataset.getCellData(i, "salesDate") + ",";
                    csvData += salesDataset.getCellData(i, "salesperson") + ",";
                    csvData += salesDataset.getCellData(i, "region") + ",";
                    csvData += salesDataset.getCellData(i, "status") + "\n";
                }
                
                // 실제로는 파일로 저장하지만, 여기서는 알림으로 표시
                alert("CSV 데이터가 생성되었습니다!\n\n" + csvData.substring(0, 500) + "...");
            }
            
            /*
                통계 정보 업데이트 (로컬 데이터 기반)
            */
            function updateStatistics() {
                var rowCount = salesDataset.getRowCount();
                var totalSales = 0;
                var categoryStats = {};
                var regionStats = {};
                var statusStats = {};
                
                for (var i = 0; i < rowCount; i++) {
                    var total = salesDataset.getCellData(i, "total");
                    var category = salesDataset.getCellData(i, "category");
                    var region = salesDataset.getCellData(i, "region");
                    var status = salesDataset.getCellData(i, "status");
                    
                    totalSales += total;
                    
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                    regionStats[region] = (regionStats[region] || 0) + 1;
                    statusStats[status] = (statusStats[status] || 0) + 1;
                }
                
                var statsText = "로컬 통계 - 총 판매액: " + totalSales.toLocaleString() + "원 | ";
                statsText += "총 건수: " + rowCount + "건 | ";
                statsText += "평균 판매액: " + (rowCount > 0 ? (totalSales / rowCount).toFixed(0) : 0).toLocaleString() + "원";
                
                statsLabel.set_text(statsText);
            }
            
            /*
                데이터 추가 다이얼로그 표시
            */
            function showAddDataDialog() {
                var productName = prompt("제품명을 입력하세요:");
                if (!productName) return;
                
                var category = prompt("카테고리를 입력하세요 (전자제품, 가구, 가전제품 등):");
                if (!category) return;
                
                var price = prompt("가격을 입력하세요:");
                if (!price || isNaN(price)) {
                    alert("올바른 가격을 입력하세요.");
                    return;
                }
                
                var quantity = prompt("수량을 입력하세요:");
                if (!quantity || isNaN(quantity)) {
                    alert("올바른 수량을 입력하세요.");
                    return;
                }
                
                var salesDate = prompt("판매일을 입력하세요 (YYYY-MM-DD 형식):");
                if (!salesDate) return;
                
                var salesperson = prompt("판매원을 입력하세요:");
                if (!salesperson) return;
                
                var region = prompt("지역을 입력하세요:");
                if (!region) return;
                
                var status = prompt("상태를 입력하세요 (완료, 진행중, 대기, 취소):");
                if (!status) return;
                
                var newSalesData = {
                    productName: productName,
                    category: category,
                    price: parseInt(price),
                    quantity: parseInt(quantity),
                    salesDate: salesDate,
                    salesperson: salesperson,
                    region: region,
                    status: status
                };
                
                addSalesDataToAPI(newSalesData);
            }
            
            /*
                선택된 행들 삭제
            */
            function deleteSelectedRows() {
                var selectedIndices = mainGrid.get_selectedindices();
                if (!selectedIndices || selectedIndices.length === 0) {
                    alert("삭제할 행을 선택하세요.");
                    return;
                }
                
                if (!confirm("선택된 " + selectedIndices.length + "개 행을 삭제하시겠습니까?")) {
                    return;
                }
                
                // 선택된 행들의 ID를 수집
                var idsToDelete = [];
                for (var i = 0; i < selectedIndices.length; i++) {
                    var rowIndex = selectedIndices[i];
                    var id = salesDataset.getCellData(rowIndex, "id");
                    idsToDelete.push(id);
                }
                
                // 각 ID에 대해 삭제 API 호출
                var deleteCount = 0;
                for (var i = 0; i < idsToDelete.length; i++) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("DELETE", API_BASE_URL + "/sales/" + idsToDelete[i], true);
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            deleteCount++;
                            if (deleteCount === idsToDelete.length) {
                                // 모든 삭제 완료 후 데이터 새로고침
                                loadSalesDataFromAPI();
                                statusBar.set_text(idsToDelete.length + "개 행이 삭제되었습니다");
                            }
                        }
                    };
                    
                    xhr.send();
                }
            }
            
            /*
                상태바 업데이트
            */
            function updateStatusBar() {
                var rowCount = salesDataset.getRowCount();
                var selectedRows = mainGrid.get_selectedindices();
                var selectedCount = selectedRows ? selectedRows.length : 0;
                
                statusBar.set_text("총 " + rowCount + "개 레코드 | 선택된 행: " + selectedCount + "개");
                updateStatistics();
            }
            
            /*
                ===== 4단계: 이벤트 핸들러 연결 =====
            */
            
            // 툴바 버튼 이벤트
            sortButton.addEventHandler("onclick", function() {
                var column = prompt("정렬할 컬럼을 입력하세요 (productName, category, price, total, salesDate, salesperson, region):");
                if (column) {
                    var ascending = confirm("오름차순으로 정렬하시겠습니까? (아니오를 선택하면 내림차순)");
                    sortGrid(column, ascending);
                }
            });
            
            filterButton.addEventHandler("onclick", function() {
                filterContainer.set_visible(!filterContainer.get_visible());
            });
            
            groupButton.addEventHandler("onclick", function() {
                groupByCategory();
            });
            
            editButton.addEventHandler("onclick", function() {
                toggleEditMode();
            });
            
            exportButton.addEventHandler("onclick", function() {
                exportData();
            });
            
            refreshButton.addEventHandler("onclick", function() {
                clearFilters();
                loadStatisticsFromAPI(); // API 통계도 함께 새로고침
            });
            
            addButton.addEventHandler("onclick", function() {
                showAddDataDialog();
            });
            
            deleteButton.addEventHandler("onclick", function() {
                deleteSelectedRows();
            });
            
            statsButton.addEventHandler("onclick", function() {
                loadStatisticsFromAPI();
            });
            
            // 필터 버튼 이벤트
            applyFilterButton.addEventHandler("onclick", function() {
                applyFilters();
            });
            
            clearFilterButton.addEventHandler("onclick", function() {
                clearFilters();
            });
            
            // 그리드 이벤트
            mainGrid.addEventHandler("onrowchanged", function() {
                updateStatusBar();
            });
            
            mainGrid.addEventHandler("oncellchanged", function() {
                if (isEditMode) {
                    updateStatusBar();
                }
            });
            
            // 필터 입력 이벤트
            productFilterText.addEventHandler("onchanged", function() {
                // 실시간 필터링 (선택사항)
                // applyFilters();
            });
            
            /*
                ===== 5단계: 초기 설정 =====
            */
            updateStatusBar();
            loadStatisticsFromAPI(); // API 통계 로드
            
            /*
                ===== 6단계: 모든 컴포넌트를 화면에 추가 =====
            */
            this.add(titleLabel);
            this.add(toolbarContainer);
            this.add(sortButton);
            this.add(filterButton);
            this.add(groupButton);
            this.add(editButton);
            this.add(exportButton);
            this.add(refreshButton);
            this.add(addButton);
            this.add(deleteButton);
            this.add(statsButton);
            this.add(filterContainer);
            this.add(productFilterLabel);
            this.add(productFilterText);
            this.add(categoryFilterLabel);
            this.add(categoryFilterCombo);
            this.add(regionFilterLabel);
            this.add(regionFilterCombo);
            this.add(applyFilterButton);
            this.add(clearFilterButton);
            this.add(mainGrid);
            this.add(statusBar);
            this.add(statsLabel);
            
            /*
                ===== 정리 =====
                이 예제에서 배운 고급 그리드 기능들:
                
                1. 정렬 기능:
                   - 단일 컬럼 정렬
                   - 오름차순/내림차순
                   - 문자열과 숫자 정렬
                
                2. 필터링 기능:
                   - 텍스트 검색
                   - 콤보박스 필터
                   - 다중 조건 필터
                   - 실시간 필터링
                
                3. 그룹핑 기능:
                   - 카테고리별 그룹핑
                   - 그룹별 집계
                   - 그룹 헤더 표시
                
                4. 편집 기능:
                   - 인라인 편집
                   - 편집 모드 토글
                   - 셀 편집 이벤트
                
                5. 데이터 관리:
                   - 다중 선택
                   - 데이터 내보내기
                   - 원본 데이터 백업
                
                6. 사용자 경험:
                   - 상태바와 통계 정보
                   - 툴바와 컨텍스트 메뉴
                   - 시각적 피드백
                
                DHTMLX 그리드와 유사한 고급 기능들을 Nexacro로 구현할 수 있습니다!
            */
        }
    </script>
</body>
</html>
